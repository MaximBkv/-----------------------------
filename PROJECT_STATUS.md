# –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ

–î–∞—Ç–∞: 2024-11-21  
–°—Ç–∞—Ç—É—Å: **–ì–û–¢–û–í –ö –ó–ê–ü–£–°–ö–£**

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞

### ‚úÖ Docker –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [x] docker-compose.yml - –≤–∞–ª–∏–¥–µ–Ω, –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] .env - –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] –í—Å–µ volumes —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] Network configuration - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞

### ‚úÖ Apache Kafka
- [x] kafka-init.sh - —Å–æ–∑–¥–∞–Ω–∏–µ 4 —Ç–æ–ø–∏–∫–æ–≤ —Å 3 –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –∫–∞–∂–¥—ã–π
- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: retention 7 –¥–Ω–µ–π, replication factor 1
- [x] –ü—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

### ‚úÖ ClickHouse
- [x] init-db.sql - 233 —Å—Ç—Ä–æ–∫–∏ SQL
  - 4 staging —Ç–∞–±–ª–∏—Ü—ã (MergeTree, TTL 90 –¥–Ω–µ–π)
  - 3 DWH —Ç–∞–±–ª–∏—Ü—ã (fact + 2 dimensions)
  - 2 –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (AggregatingMergeTree)
  - 2 materialized views –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
- [x] clickhouse-config.xml - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- [x] –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º
- [x] TTL –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

### ‚úÖ Apache Airflow
**4 production-ready DAGs:**

1. **init_data_pipeline.py** (156 —Å—Ç—Ä–æ–∫)
   - –°–æ–∑–¥–∞–Ω–∏–µ Kafka —Ç–æ–ø–∏–∫–æ–≤
   - –ó–∞–≥—Ä—É–∑–∫–∞ 4 —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –∏–∑ JSONL
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å: ‚úì

2. **streaming_to_clickhouse.py** (176 —Å—Ç—Ä–æ–∫)
   - Kafka Consumer –¥–ª—è 4 —Ç–æ–ø–∏–∫–æ–≤
   - –ë–∞—Ç—á–µ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞ –≤ ClickHouse (1000 –∑–∞–ø–∏—Å–µ–π)
   - Schedule: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å: ‚úì

3. **build_dwh_layer.py** (263 —Å—Ç—Ä–æ–∫–∏)
   - JOIN staging —Ç–∞–±–ª–∏—Ü –≤ fact_events
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ dim_users –∏ dim_geo
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü (OPTIMIZE TABLE)
   - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (>7 –¥–Ω–µ–π)
   - Schedule: –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å: ‚úì

4. **data_quality_checks.py** (286 —Å—Ç—Ä–æ–∫)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ NULL –∑–Ω–∞—á–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ—á–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
   - Schedule: –∫–∞–∂–¥—ã–π —á–∞—Å
   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å: ‚úì

**2 Python plugins:**

1. **kafka_producer.py** (94 —Å—Ç—Ä–æ–∫–∏)
   - DataPlatformKafkaProducer –∫–ª–∞—Å—Å
   - –ë–∞—Ç—á–µ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Kafka
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å: ‚úì

2. **clickhouse_utils.py** (172 —Å—Ç—Ä–æ–∫–∏)
   - ClickHouseConnection –∫–ª–∞—Å—Å
   - Context manager –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - –£—Ç–∏–ª–∏—Ç—ã: insert_batch, execute_query, optimize_table
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å: ‚úì

**Dependencies:**
- kafka-python==2.0.2
- clickhouse-driver==0.2.6
- clickhouse-connect==0.6.23
- pandas==2.1.3
- jsonschema==4.20.0

### ‚úÖ Apache Superset
- [x] superset-init.sh - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ ClickHouse
- [x] –ü—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [x] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∫ ClickHouse

### ‚úÖ –î–∞–Ω–Ω—ã–µ
**4 JSONL —Ñ–∞–π–ª–∞:**
- [x] browser_events.jsonl (354 KB)
- [x] device_events.jsonl (288 KB)
- [x] geo_events.jsonl (223 KB)
- [x] location_events.jsonl (292 KB)

**–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:**
- [x] JSON –≤–∞–ª–∏–¥–µ–Ω
- [x] JSONL –ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- [x] –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

### ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] README.md (428 —Å—Ç—Ä–æ–∫) - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- [x] QUICKSTART.md (201 —Å—Ç—Ä–æ–∫–∞) - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- [x] .env.example - —à–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [x] .gitignore - –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] PROJECT_STATUS.md - —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–î–∞–Ω–Ω—ã–µ (JSONL) 
    ‚Üì
[Airflow: init_data_pipeline]
    ‚Üì
Kafka (4 —Ç–æ–ø–∏–∫–∞, 3 –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∫–∞–∂–¥—ã–π)
    ‚Üì
[Airflow: streaming_to_clickhouse, schedule=5m]
    ‚Üì
ClickHouse Staging (4 —Ç–∞–±–ª–∏—Ü—ã)
    ‚Üì
[Airflow: build_dwh_layer, schedule=15m]
    ‚Üì
ClickHouse DWH (fact + dims + aggregates)
    ‚Üì
[Airflow: data_quality_checks, schedule=1h]
    ‚Üì
Superset Dashboards
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- Kafka batch size: 1000 —Å–æ–æ–±—â–µ–Ω–∏–π
- ClickHouse –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø–æ –º–µ—Å—è—Ü–∞–º
- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
- TTL: 90 –¥–Ω–µ–π staging, 365 –¥–Ω–µ–π DWH

**–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- Kafka: 3 –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞ —Ç–æ–ø–∏–∫ (–ª–µ–≥–∫–æ —É–≤–µ–ª–∏—á–∏—Ç—å)
- ClickHouse: MergeTree + –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- Airflow: LocalExecutor (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ Celery)

**–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:**
- Kafka: consumer groups —Å commit
- ClickHouse: ReplicatedMergeTree –≥–æ—Ç–æ–≤ –∫ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
- Airflow: retry 2-3 —Ä–∞–∑–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
- Docker: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- Airflow UI: —Å—Ç–∞—Ç—É—Å DAGs –∏ –∑–∞–¥–∞—á
- ClickHouse: system.query_log
- Docker: –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- Data quality checks: hourly –æ—Ç—á–µ—Ç—ã

---

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

‚úÖ **Streaming pipeline**
- Kafka producer –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- Kafka consumer —Å –±–∞—Ç—á–µ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –ü–æ—Ç–æ–∫–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ ClickHouse

‚úÖ **Data warehouse**
- Staging —Å–ª–æ–π (raw –¥–∞–Ω–Ω—ã–µ)
- DWH —Å–ª–æ–π (facts + dimensions)
- –ê–≥—Ä–µ–≥–∞—Ç—ã —Å materialized views

‚úÖ **ETL orchestration**
- 4 –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏—Ö DAG
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
- Error handling –∏ retry logic

‚úÖ **Data quality**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
- –û—Ç—á–µ—Ç—ã –æ –∫–∞—á–µ—Å—Ç–≤–µ

‚úÖ **Visualization**
- Superset —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ClickHouse
- –ì–æ—Ç–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –¥–∞—à–±–æ—Ä–¥–æ–≤

‚úÖ **Infrastructure as Code**
- Docker Compose –¥–ª—è –≤—Å–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- –ì–æ—Ç–æ–≤ –∫ production deployment

‚úÖ **Documentation**
- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- Quick start guide
- Troubleshooting —Å–µ–∫—Ü–∏—è
- –ü—Ä–∏–º–µ—Ä—ã SQL –∑–∞–ø—Ä–æ—Å–æ–≤

---

## –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∑–∞–ø—É—Å–∫—É

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- [x] Docker Desktop 4.x+
- [x] Docker Compose 2.x+
- [x] 8 GB RAM –º–∏–Ω–∏–º—É–º
- [x] 20 GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞
```bash
# –ó–∞–ø—É—Å–∫
docker-compose up -d

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Kafka
docker exec kafka bash /scripts/kafka-init.sh

# –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º
# Airflow: http://localhost:8080 (admin/admin)
# Superset: http://localhost:8088 (admin/admin)
```

---

## Best Practices –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

‚úÖ **Data Engineering:**
- Staging ‚Üí DWH –ø–∞—Ç—Ç–µ—Ä–Ω
- Incremental loading
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- TTL –¥–ª—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

‚úÖ **Software Engineering:**
- –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (plugins)
- Error handling
- Logging
- Type hints –≤ Python

‚úÖ **DevOps:**
- Infrastructure as Code
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- Environment variables
- Volume persistence
- Network isolation

‚úÖ **Code Quality:**
- Python —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤–∞–ª–∏–¥–µ–Ω
- SQL –∑–∞–ø—Ä–æ—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- –ù–µ—Ç hardcoded –∑–Ω–∞—á–µ–Ω–∏–π
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ

---

## –ò—Ç–æ–≥–æ

**–°—Ç–∞—Ç—É—Å: PRODUCTION-READY** üöÄ

–ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** `docker-compose up -d`
